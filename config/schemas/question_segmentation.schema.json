{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Canonical Question Segmentation Output",
  "type": "object",
  "required": ["metadata", "question_segments", "question_segment_index"],
  "properties": {
    "metadata": {
      "type": "object",
      "required": [
        "questionnaire_version",
        "rubric_version",
        "total_contracts",
        "covered_contracts",
        "coverage_ratio",
        "total_segments",
        "input_sha256",
        "contracts_sha256",
        "segmentation_method"
      ],
      "properties": {
        "questionnaire_version": {"type": ["string", "null"]},
        "rubric_version": {"type": ["string", "null"]},
        "total_contracts": {"type": "integer", "minimum": 0},
        "covered_contracts": {"type": "integer", "minimum": 0},
        "coverage_ratio": {"type": "number", "minimum": 0.0, "maximum": 1.0},
        "total_segments": {"type": "integer", "minimum": 0},
        "input_sha256": {"type": "string", "pattern": "^[a-f0-9]{64}$"},
        "contracts_sha256": {"type": "string", "pattern": "^[a-f0-9]{64}$"},
        "segmentation_method": {"type": "string"}
      },
      "additionalProperties": true
    },
    "question_segments": {
      "type": "object",
      "additionalProperties": {
        "type": "object",
        "required": [
          "legacy_question_id",
          "policy_area_id",
          "dimension_id",
          "policy_area_legacy",
          "dimension_legacy",
          "question_number",
          "question_template",
          "scoring_modality",
          "evidence_sources",
          "contract_hash",
          "evidence_manifest"
        ],
        "properties": {
          "legacy_question_id": {"type": "string"},
          "policy_area_id": {"type": "string"},
          "dimension_id": {"type": "string"},
          "policy_area_legacy": {"type": "string"},
          "dimension_legacy": {"type": "string"},
          "question_number": {"type": "integer"},
          "question_template": {"type": "string"},
          "scoring_modality": {"type": "string"},
          "evidence_sources": {"type": ["object", "array"]},
          "contract_hash": {"type": "string", "pattern": "^[a-f0-9]{64}$"},
          "evidence_manifest": {
            "type": "object",
            "required": [
              "matched",
              "matched_segment_count",
              "expected_elements",
              "search_patterns",
              "verification_patterns",
              "evaluation_criteria",
              "pattern_hits",
              "matched_segments",
              "attestation"
            ],
            "properties": {
              "matched": {"type": "boolean"},
              "matched_segment_count": {"type": "integer", "minimum": 0},
              "expected_elements": {"type": "array"},
              "search_patterns": {"type": "object"},
              "verification_patterns": {"type": "array"},
              "evaluation_criteria": {"type": "object"},
              "pattern_hits": {"type": "object"},
              "matched_segments": {
                "type": "array",
                "items": {
                  "type": "object",
                  "required": [
                    "segment_index",
                    "segment_text",
                    "segment_hash",
                    "matched_patterns"
                  ],
                  "properties": {
                    "segment_index": {"type": "integer", "minimum": 0},
                    "segment_text": {"type": "string"},
                    "segment_hash": {"type": "string", "pattern": "^[a-f0-9]{64}$"},
                    "matched_patterns": {"type": "array", "items": {"type": "string"}}
                  },
                  "additionalProperties": true
                }
              },
              "attestation": {
                "type": "object",
                "required": ["contract_sha256", "segment_hash_chain"],
                "properties": {
                  "contract_sha256": {"type": "string", "pattern": "^[a-f0-9]{64}$"},
                  "segment_hash_chain": {"type": "string", "pattern": "^[a-f0-9]{64}$"}
                },
                "additionalProperties": true
              }
            },
            "additionalProperties": true
          }
        },
        "additionalProperties": true
      }
    },
    "question_segment_index": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "key_tuple",
          "canonical_question_id",
          "policy_area_id",
          "dimension_id",
          "legacy_question_id",
          "contract_hash",
          "evidence_manifest"
        ],
        "properties": {
          "key_tuple": {
            "type": "array",
            "items": {"type": "string"},
            "minItems": 3,
            "maxItems": 3
          },
          "canonical_question_id": {"type": "string"},
          "policy_area_id": {"type": "string"},
          "dimension_id": {"type": "string"},
          "legacy_question_id": {"type": "string"},
          "contract_hash": {"type": "string", "pattern": "^[a-f0-9]{64}$"},
          "evidence_manifest": {"$ref": "#/properties/question_segments/additionalProperties/properties/evidence_manifest"}
        },
        "additionalProperties": true
      }
    }
  },
  "additionalProperties": false
}
