{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://saaaaaa.policy.analysis/schemas/embedding_policy/semantic_chunk.schema.json",
  "title": "SemanticChunk",
  "description": "Chunk semántico estructurado con preservación de contexto jerárquico, metadatos P-D-Q y embeddings multilingües",
  "type": "object",
  "required": ["chunk_id", "content", "embedding", "metadata", "token_count", "position"],
  "properties": {
    "chunk_id": {
      "type": "string",
      "pattern": "^[a-f0-9]{16}$",
      "description": "Identificador único del chunk (SHA-256 truncado a 16 caracteres hex)"
    },
    "content": {
      "type": "string",
      "minLength": 64,
      "maxLength": 4096,
      "description": "Contenido textual del chunk (optimizado para modelos de 512 tokens con overlap de 128)"
    },
    "embedding": {
      "type": "array",
      "items": {"type": "number"},
      "minItems": 768,
      "maxItems": 768,
      "description": "Vector de embeddings semánticos (sentence-transformers/paraphrase-multilingual-mpnet-base-v2, 768 dimensiones)"
    },
    "metadata": {
      "type": "object",
      "required": ["document_id", "chunk_index"],
      "properties": {
        "document_id": {
          "type": "string",
          "description": "ID del documento fuente"
        },
        "chunk_index": {
          "type": "integer",
          "minimum": 0,
          "description": "Índice secuencial del chunk en el documento"
        },
        "has_table": {
          "type": "boolean",
          "description": "TRUE si el chunk contiene una tabla (detectada con regex)"
        },
        "has_list": {
          "type": "boolean",
          "description": "TRUE si el chunk contiene una lista/enumeración"
        },
        "has_numbers": {
          "type": "boolean",
          "description": "TRUE si el chunk contiene indicadores numéricos (\\d+[.,]?\\d*[%|millones|mil|billones]?)"
        },
        "section_title": {
          "oneOf": [
            {"type": "null"},
            {
              "type": "string",
              "description": "Título de la sección que contiene el chunk (CAPÍTULO|SECCIÓN|ARTÍCULO|PROGRAMA|PROYECTO|EJE)"
            }
          ]
        },
        "structural_level": {
          "type": "integer",
          "minimum": 0,
          "maximum": 10,
          "description": "Nivel jerárquico en la estructura del documento (0=raíz)"
        },
        "contains_indicator": {
          "type": "boolean",
          "description": "TRUE si contiene indicadores de resultado/producto/gestión"
        },
        "language_quality_score": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Calidad del lenguaje (coherencia, gramática, formalidad)"
        },
        "policy_domains_detected": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "P1_Derechos de las mujeres e igualdad de género",
              "P2_Prevención de la violencia y protección frente al conflicto",
              "P3_Ambiente sano, cambio climático, prevención y atención a desastres",
              "P4_Derechos económicos, sociales y culturales",
              "P5_Derechos de las víctimas y construcción de paz",
              "P6_Derecho al buen futuro de la niñez, adolescencia, juventud",
              "P7_Tierras y territorios",
              "P8_Líderes y defensores de derechos humanos",
              "P9_Crisis de derechos de personas privadas de la libertad",
              "P10_Migración transfronteriza"
            ]
          },
          "description": "Dominios de política detectados en el chunk (P1-P10 del Decálogo)",
          "uniqueItems": true
        },
        "analytical_dimensions_detected": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "D1_Diagnóstico y Recursos",
              "D2_Diseño de Intervención",
              "D3_Productos y Outputs",
              "D4_Resultados y Outcomes",
              "D5_Impactos y Efectos de Largo Plazo",
              "D6_Teoría de Cambio y Coherencia Causal"
            ]
          },
          "description": "Dimensiones analíticas detectadas (D1-D6)",
          "uniqueItems": true
        },
        "extracted_at": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp de extracción del chunk"
        },
        "preprocessing_applied": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "whitespace_normalization",
              "paragraph_preservation",
              "sentence_boundary_detection",
              "table_structure_preservation",
              "list_marker_preservation"
            ]
          },
          "description": "Pasos de preprocesamiento aplicados"
        }
      },
      "additionalProperties": true
    },
    "pdq_context": {
      "oneOf": [
        {"type": "null"},
        {
          "type": "object",
          "required": ["question_unique_id", "policy", "dimension", "question", "rubric_key"],
          "properties": {
            "question_unique_id": {
              "type": "string",
              "pattern": "^P(\\d|10)-D[1-6]-Q[1-5]$",
              "description": "Identificador único P-D-Q canónico",
              "examples": ["P1-D1-Q1", "P10-D6-Q5"]
            },
            "policy": {
              "type": "string",
              "pattern": "^P(\\d|10)$",
              "description": "Área de política (P1-P10)",
              "examples": ["P1", "P10"]
            },
            "dimension": {
              "type": "string",
              "pattern": "^D[1-6]$",
              "description": "Dimensión analítica (D1-D6)",
              "examples": ["D1", "D6"]
            },
            "question": {
              "type": "integer",
              "minimum": 1,
              "maximum": 5,
              "description": "Número de pregunta (1-5)"
            },
            "rubric_key": {
              "type": "string",
              "pattern": "^D[1-6]-Q[1-5]$",
              "description": "Clave de rúbrica (D#-Q#)",
              "examples": ["D1-Q1", "D6-Q5"]
            },
            "inference_confidence": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 1.0,
              "description": "Confianza en la inferencia del contexto P-D-Q"
            }
          },
          "additionalProperties": false
        }
      ],
      "description": "Contexto P-D-Q inferido del chunk (null si no se pudo inferir)"
    },
    "token_count": {
      "type": "integer",
      "minimum": 1,
      "maximum": 1024,
      "description": "Conteo aproximado de tokens (Spanish: ~1.3 chars/token)"
    },
    "position": {
      "type": "array",
      "items": {"type": "integer", "minimum": 0},
      "minItems": 2,
      "maxItems": 2,
      "description": "Posición en el documento: [start_char, end_char]"
    },
    "semantic_features": {
      "type": "object",
      "description": "Features semánticos adicionales para análisis avanzado",
      "properties": {
        "sentence_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Número de oraciones en el chunk"
        },
        "avg_sentence_length": {
          "type": "number",
          "minimum": 0,
          "description": "Longitud promedio de oraciones (en tokens)"
        },
        "lexical_diversity": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Diversidad léxica (type-token ratio)"
        },
        "named_entities": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "text": {"type": "string"},
              "label": {"type": "string"},
              "start": {"type": "integer"},
              "end": {"type": "integer"}
            }
          },
          "description": "Entidades nombradas extraídas con spaCy"
        },
        "key_phrases": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Frases clave extraídas (TF-IDF o RAKE)",
          "maxItems": 20
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
