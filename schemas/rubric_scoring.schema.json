{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://saaaaaa.policy.analysis/schemas/rubric_scoring.schema.json",
  "title": "RubricScoringV2",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "version",
    "requires_questionnaire_version",
    "content_hash",
    "metadata",
    "provenance",
    "changelog",
    "scoring_modalities",
    "aggregation",
    "na_rules",
    "penalties",
    "score_bands",
    "rubric_matrix",
    "recommendation_rules",
    "imbalance",
    "uncertainty",
    "required_evidence_keys"
  ],
  "$defs": {
    "semver": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "sha256": {
      "type": "string",
      "pattern": "^[0-9a-f]{64}$"
    },
    "weight": {
      "type": "number",
      "minimum": 0,
      "maximum": 1
    },
    "i18nLabel": {
      "type": "object",
      "required": ["default", "keys"],
      "properties": {
        "default": {
          "type": "string",
          "enum": ["es"]
        },
        "keys": {
          "type": "object",
          "required": ["label_es", "label_en"],
          "properties": {
            "label_es": {
              "type": "string",
              "minLength": 1
            },
            "label_en": {
              "type": "string",
              "minLength": 1
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "evidenceKeys": {
      "type": "array",
      "minItems": 1,
      "uniqueItems": true,
      "items": {
        "type": "string",
        "pattern": "^[a-z]+(_[a-z]+)*$"
      }
    },
    "rounding": {
      "type": "object",
      "required": ["mode", "precision"],
      "additionalProperties": false,
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["half_up", "bankers", "truncate"]
        },
        "precision": {
          "type": "integer",
          "minimum": 0,
          "maximum": 4
        }
      }
    }
  },
  "properties": {
    "version": {
      "$ref": "#/$defs/semver"
    },
    "requires_questionnaire_version": {
      "$ref": "#/$defs/semver"
    },
    "content_hash": {
      "$ref": "#/$defs/sha256"
    },
    "metadata": {
      "type": "object",
      "required": ["default_language", "rounding", "uncertainty", "tie_breaker_notes"],
      "additionalProperties": false,
      "properties": {
        "default_language": {
          "type": "string",
          "enum": ["es"]
        },
        "rounding": {
          "type": "object",
          "required": ["question", "dimension", "policy_area", "cluster", "macro"],
          "additionalProperties": false,
          "properties": {
            "question": { "$ref": "#/$defs/rounding" },
            "dimension": { "$ref": "#/$defs/rounding" },
            "policy_area": { "$ref": "#/$defs/rounding" },
            "cluster": { "$ref": "#/$defs/rounding" },
            "macro": { "$ref": "#/$defs/rounding" }
          }
        },
        "uncertainty": {
          "type": "object",
          "required": ["method", "alpha", "propagation"],
          "additionalProperties": false,
          "properties": {
            "method": {
              "type": "string",
              "enum": ["interval", "bootstrap"]
            },
            "alpha": {
              "type": "number",
              "exclusiveMinimum": 0,
              "maximum": 0.5
            },
            "propagation": {
              "type": "string",
              "enum": ["weighted", "simple"]
            },
            "iterations": {
              "type": "integer",
              "minimum": 100
            }
          }
        },
        "tie_breaker_notes": {
          "type": "string",
          "minLength": 10
        }
      }
    },
    "provenance": {
      "type": "object",
      "required": ["author", "tool", "edited_at"],
      "additionalProperties": false,
      "properties": {
        "author": { "type": "string", "minLength": 3 },
        "tool": { "type": "string", "minLength": 3 },
        "edited_at": { "type": "string", "format": "date-time" }
      }
    },
    "changelog": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["version", "summary", "reason"],
        "additionalProperties": false,
        "properties": {
          "version": { "$ref": "#/$defs/semver" },
          "summary": { "type": "string", "minLength": 5 },
          "reason": { "type": "string", "minLength": 5 }
        }
      }
    },
    "scoring_modalities": {
      "type": "object",
      "minProperties": 1,
      "patternProperties": {
        "^TYPE_[A-F]$": {
          "type": "object",
          "required": ["name", "description", "score_range", "rounding", "required_evidence_keys"],
          "additionalProperties": true,
          "properties": {
            "name": { "type": "string", "minLength": 3 },
            "description": { "type": "string", "minLength": 5 },
            "score_range": {
              "type": "object",
              "required": ["min", "max"],
              "additionalProperties": false,
              "properties": {
                "min": { "type": "number", "minimum": 0 },
                "max": { "type": "number", "minimum": 0 }
              }
            },
            "rounding": { "$ref": "#/$defs/rounding" },
            "required_evidence_keys": { "$ref": "#/$defs/evidenceKeys" },
            "expected_elements": { "type": "integer", "minimum": 1 },
            "conversion_table": {
              "type": "object",
              "patternProperties": {
                "^\\d+$": { "type": "number", "minimum": 0 }
              },
              "additionalProperties": false
            },
            "determinism": {
              "type": "object",
              "required": ["seed_required", "seed_source"],
              "additionalProperties": false,
              "properties": {
                "seed_required": { "type": "boolean" },
                "seed_source": { "type": "string", "minLength": 3 }
              }
            }
          }
        }
      }
    },
    "aggregation": {
      "type": "object",
      "required": [
        "dimension_question_weights",
        "policy_area_dimension_weights",
        "cluster_policy_area_weights",
        "macro_cluster_weights"
      ],
      "additionalProperties": false,
      "properties": {
        "dimension_question_weights": {
          "type": "object",
          "patternProperties": {
            "^DIM0[1-6]$": {
              "type": "object",
              "minProperties": 1,
              "patternProperties": {
                "^Q\\d{3}$": { "$ref": "#/$defs/weight" }
              },
              "additionalProperties": false
            }
          }
        },
        "policy_area_dimension_weights": {
          "type": "object",
          "patternProperties": {
            "^PA(0[1-9]|10)$": {
              "type": "object",
              "minProperties": 6,
              "maxProperties": 6,
              "patternProperties": {
                "^DIM0[1-6]$": { "$ref": "#/$defs/weight" }
              },
              "additionalProperties": false
            }
          }
        },
        "cluster_policy_area_weights": {
          "type": "object",
          "patternProperties": {
            "^CL0[1-4]$": {
              "type": "object",
              "minProperties": 1,
              "patternProperties": {
                "^PA(0[1-9]|10)$": { "$ref": "#/$defs/weight" }
              },
              "additionalProperties": false
            }
          }
        },
        "macro_cluster_weights": {
          "type": "object",
          "minProperties": 4,
          "maxProperties": 4,
          "patternProperties": {
            "^CL0[1-4]$": { "$ref": "#/$defs/weight" }
          },
          "additionalProperties": false
        }
      }
    },
    "na_rules": {
      "type": "object",
      "required": ["modalities", "policy_areas"],
      "additionalProperties": false,
      "properties": {
        "modalities": {
          "type": "object",
          "patternProperties": {
            "^TYPE_[A-F]$": {
              "type": "object",
              "required": ["imputation", "scope", "exclude_from_global"],
              "additionalProperties": false,
              "properties": {
                "imputation": {
                  "type": "string",
                  "enum": ["none", "zero", "mean", "median"]
                },
                "scope": {
                  "type": "string",
                  "enum": ["dimension", "policy_area"]
                },
                "exclude_from_global": {
                  "type": "boolean"
                }
              }
            }
          }
        },
        "policy_areas": {
          "type": "object",
          "patternProperties": {
            "^PA(0[1-9]|10)$": {
              "type": "object",
              "required": ["imputation", "scope", "exclude_from_global"],
              "additionalProperties": false,
              "properties": {
                "imputation": {
                  "type": "string",
                  "enum": ["none", "zero", "mean", "median"]
                },
                "scope": {
                  "type": "string",
                  "enum": ["dimension", "policy_area"]
                },
                "exclude_from_global": { "type": "boolean" }
              }
            }
          }
        }
      }
    },
    "penalties": {
      "type": "object",
      "required": ["contradictory_info", "missing_indicator", "OOD_flag"],
      "additionalProperties": false,
      "properties": {
        "contradictory_info": {
          "type": "object",
          "required": ["weight"],
          "additionalProperties": false,
          "properties": { "weight": { "$ref": "#/$defs/weight" } }
        },
        "missing_indicator": {
          "type": "object",
          "required": ["weight"],
          "additionalProperties": false,
          "properties": { "weight": { "$ref": "#/$defs/weight" } }
        },
        "OOD_flag": {
          "type": "object",
          "required": ["weight"],
          "additionalProperties": false,
          "properties": { "weight": { "$ref": "#/$defs/weight" } }
        }
      }
    },
    "score_bands": {
      "type": "object",
      "minProperties": 1,
      "patternProperties": {
        "^[A-Z_]+$": {
          "type": "object",
          "required": ["min", "max", "description", "recommendation"],
          "additionalProperties": false,
          "properties": {
            "min": { "type": "number", "minimum": 0 },
            "max": { "type": "number", "minimum": 0 },
            "description": { "type": "string", "minLength": 5 },
            "recommendation": { "type": "string", "minLength": 5 },
            "color": { "type": "string" },
            "emoji": { "type": "string" }
          }
        }
      }
    },
    "rubric_matrix": {
      "type": "object",
      "patternProperties": {
        "^PA(0[1-9]|10)$": {
          "type": "object",
          "minProperties": 1,
          "patternProperties": {
            "^DIM0[1-6]$": {
              "type": "object",
              "required": ["default_modality", "allowed_modalities", "required_evidence_keys"],
              "additionalProperties": false,
              "properties": {
                "default_modality": {
                  "type": "string",
                  "enum": ["TYPE_A", "TYPE_B", "TYPE_C", "TYPE_D", "TYPE_E", "TYPE_F"]
                },
                "allowed_modalities": {
                  "type": "array",
                  "minItems": 1,
                  "items": {
                    "type": "string",
                    "enum": ["TYPE_A", "TYPE_B", "TYPE_C", "TYPE_D", "TYPE_E", "TYPE_F"]
                  },
                  "uniqueItems": true
                },
                "required_evidence_keys": { "$ref": "#/$defs/evidenceKeys" }
              }
            }
          }
        }
      }
    },
    "recommendation_rules": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["cluster_id", "condition", "action"],
        "additionalProperties": false,
        "properties": {
          "cluster_id": { "type": "string", "pattern": "^CL0[1-4]$" },
          "condition": {
            "type": "object",
            "required": ["type", "threshold"],
            "additionalProperties": false,
            "properties": {
              "type": {
                "type": "string",
                "enum": ["low_score", "high_imbalance", "combined"]
              },
              "threshold": { "type": "number" },
              "weak_policy_area": { "type": "string", "pattern": "^PA(0[1-9]|10)$" }
            }
          },
          "action": {
            "type": "object",
            "required": ["problem", "intervention", "indicator", "owner", "timeframe"],
            "additionalProperties": false,
            "properties": {
              "problem": { "type": "string", "minLength": 5 },
              "intervention": { "type": "string", "minLength": 5 },
              "indicator": { "type": "string", "minLength": 5 },
              "owner": { "type": "string", "minLength": 3 },
              "timeframe": { "type": "string", "minLength": 3 }
            }
          }
        }
      }
    },
    "imbalance": {
      "type": "object",
      "required": ["method", "gini_formula", "std_dev_formula", "range_formula", "thresholds"],
      "additionalProperties": false,
      "properties": {
        "method": { "type": "string", "enum": ["gini"] },
        "gini_formula": { "type": "string", "minLength": 5 },
        "std_dev_formula": { "type": "string", "minLength": 5 },
        "range_formula": { "type": "string", "minLength": 5 },
        "thresholds": {
          "type": "object",
          "patternProperties": {
            "^CL0[1-4]$": {
              "type": "object",
              "required": ["gini", "std_dev", "range", "action"],
              "additionalProperties": false,
              "properties": {
                "gini": { "type": "number", "minimum": 0 },
                "std_dev": { "type": "number", "minimum": 0 },
                "range": { "type": "number", "minimum": 0 },
                "action": { "type": "string", "enum": ["penalize", "flag"] }
              }
            }
          }
        }
      }
    },
    "uncertainty": {
      "type": "object",
      "required": ["method", "alpha", "propagation"],
      "additionalProperties": false,
      "properties": {
        "method": { "type": "string", "enum": ["interval", "bootstrap"] },
        "alpha": { "type": "number", "exclusiveMinimum": 0, "maximum": 0.5 },
        "propagation": { "type": "string", "enum": ["weighted", "simple"] },
        "iterations": { "type": "integer", "minimum": 100 }
      }
    },
    "required_evidence_keys": {
      "type": "object",
      "minProperties": 10,
      "patternProperties": {
        "^PA(0[1-9]|10)$": { "$ref": "#/$defs/evidenceKeys" }
      }
    }
  }
}
