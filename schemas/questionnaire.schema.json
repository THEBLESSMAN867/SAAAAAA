{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://saaaaaa.policy.analysis/schemas/questionnaire.schema.json",
  "title": "PolicyAnalysisQuestionnaireV2",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "version",
    "content_hash",
    "metadata",
    "provenance",
    "questions",
    "changelog"
  ],
  "$defs": {
    "semver": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "sha256": {
      "type": "string",
      "pattern": "^[0-9a-f]{64}$"
    },
    "i18nLabel": {
      "type": "object",
      "required": ["default", "keys"],
      "properties": {
        "default": {
          "type": "string",
          "enum": ["es"]
        },
        "keys": {
          "type": "object",
          "required": ["label_es", "label_en"],
          "properties": {
            "label_es": {
              "type": "string",
              "minLength": 1
            },
            "label_en": {
              "type": "string",
              "minLength": 1
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "sourceKey": {
      "type": "string",
      "pattern": "^[a-z]+(_[a-z]+)*$"
    },
    "evidenceKeyArray": {
      "type": "array",
      "minItems": 1,
      "uniqueItems": true,
      "items": {
        "$ref": "#/$defs/sourceKey"
      }
    }
  },
  "properties": {
    "version": {
      "$ref": "#/$defs/semver"
    },
    "content_hash": {
      "$ref": "#/$defs/sha256"
    },
    "metadata": {
      "type": "object",
      "required": [
        "default_language",
        "description",
        "title",
        "clusters",
        "dimensions",
        "policy_areas",
        "sources_of_verification"
      ],
      "additionalProperties": false,
      "properties": {
        "default_language": {
          "type": "string",
          "enum": ["es"]
        },
        "description": {
          "type": "string",
          "minLength": 10
        },
        "title": {
          "$ref": "#/$defs/i18nLabel"
        },
        "clusters": {
          "type": "array",
          "minItems": 4,
          "maxItems": 4,
          "items": {
            "type": "object",
            "required": ["cluster_id", "i18n", "policy_area_ids", "legacy_policy_area_ids", "rationale"],
            "additionalProperties": false,
            "properties": {
              "cluster_id": {
                "type": "string",
                "pattern": "^CL0[1-4]$"
              },
              "i18n": {
                "$ref": "#/$defs/i18nLabel"
              },
              "policy_area_ids": {
                "type": "array",
                "minItems": 1,
                "uniqueItems": true,
                "items": {
                  "type": "string",
                  "pattern": "^PA(0[1-9]|10)$"
                }
              },
              "legacy_policy_area_ids": {
                "type": "array",
                "items": {
                  "type": "string",
                  "pattern": "^P(10|[1-9])$"
                }
              },
              "rationale": {
                "type": "string",
                "minLength": 10
              }
            }
          }
        },
        "dimensions": {
          "type": "array",
          "minItems": 6,
          "maxItems": 6,
          "items": {
            "type": "object",
            "required": ["dimension_id", "legacy_id", "i18n", "description"],
            "additionalProperties": false,
            "properties": {
              "dimension_id": {
                "type": "string",
                "pattern": "^DIM0[1-6]$"
              },
              "legacy_id": {
                "type": "string",
                "pattern": "^D(6|[1-5])$"
              },
              "i18n": {
                "$ref": "#/$defs/i18nLabel"
              },
              "description": {
                "type": "string",
                "minLength": 10
              }
            }
          }
        },
        "policy_areas": {
          "type": "array",
          "minItems": 10,
          "maxItems": 10,
          "items": {
            "type": "object",
            "required": [
              "policy_area_id",
              "legacy_ids",
              "cluster_id",
              "dimension_ids",
              "i18n",
              "required_evidence_keys"
            ],
            "additionalProperties": false,
            "properties": {
              "policy_area_id": {
                "type": "string",
                "pattern": "^PA(0[1-9]|10)$"
              },
              "legacy_ids": {
                "type": "array",
                "minItems": 1,
                "items": {
                  "type": "string",
                  "pattern": "^P(10|[1-9])$"
                }
              },
              "cluster_id": {
                "type": "string",
                "pattern": "^CL0[1-4]$"
              },
              "dimension_ids": {
                "type": "array",
                "minItems": 6,
                "maxItems": 6,
                "uniqueItems": true,
                "items": {
                  "type": "string",
                  "pattern": "^DIM0[1-6]$"
                }
              },
              "i18n": {
                "$ref": "#/$defs/i18nLabel"
              },
              "required_evidence_keys": {
                "$ref": "#/$defs/evidenceKeyArray"
              }
            }
          }
        },
        "sources_of_verification": {
          "type": "array",
          "minItems": 3,
          "items": {
            "type": "object",
            "required": ["key", "type", "format", "auth_level", "description"],
            "additionalProperties": false,
            "properties": {
              "key": {
                "$ref": "#/$defs/sourceKey"
              },
              "type": {
                "type": "string",
                "enum": ["primary", "secondary"]
              },
              "format": {
                "type": "string",
                "enum": ["table", "stat", "narrative", "map"]
              },
              "auth_level": {
                "type": "string",
                "enum": ["official", "third_party"]
              },
              "description": {
                "type": "string",
                "minLength": 10
              }
            }
          },
          "uniqueItems": true
        }
      }
    },
    "provenance": {
      "type": "object",
      "required": ["author", "tool", "edited_at"],
      "additionalProperties": false,
      "properties": {
        "author": {
          "type": "string",
          "minLength": 3
        },
        "tool": {
          "type": "string",
          "minLength": 3
        },
        "edited_at": {
          "type": "string",
          "format": "date-time"
        }
      }
    },
    "changelog": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["version", "summary", "reason"],
        "additionalProperties": false,
        "properties": {
          "version": {
            "$ref": "#/$defs/semver"
          },
          "summary": {
            "type": "string",
            "minLength": 5
          },
          "reason": {
            "type": "string",
            "minLength": 5
          }
        }
      }
    },
    "questions": {
      "type": "array",
      "minItems": 300,
      "maxItems": 300,
      "uniqueItems": true,
      "items": {
        "type": "object",
        "required": [
          "question_id",
          "legacy_id",
          "policy_area_id",
          "dimension_id",
          "cluster_id",
          "order",
          "question_text",
          "i18n",
          "scoring_modality",
          "required_evidence_keys",
          "evidence_expectations",
          "search_patterns",
          "scoring_criteria",
          "validation_checks"
        ],
        "additionalProperties": false,
        "properties": {
          "question_id": {
            "type": "string",
            "pattern": "^Q[0-9]{3}$"
          },
          "legacy_id": {
            "type": "string",
            "pattern": "^P(10|[1-9])-D(6|[1-5])-Q([0-9]{1,3})$"
          },
          "policy_area_id": {
            "type": "string",
            "pattern": "^PA(0[1-9]|10)$"
          },
          "dimension_id": {
            "type": "string",
            "pattern": "^DIM0[1-6]$"
          },
          "cluster_id": {
            "type": "string",
            "pattern": "^CL0[1-4]$"
          },
          "order": {
            "type": "object",
            "required": ["global", "within_policy_area", "within_policy_area_dimension"],
            "additionalProperties": false,
            "properties": {
              "global": {
                "type": "integer",
                "minimum": 1,
                "maximum": 300
              },
              "within_policy_area": {
                "type": "integer",
                "minimum": 1,
                "maximum": 30
              },
              "within_policy_area_dimension": {
                "type": "integer",
                "minimum": 1,
                "maximum": 5
              }
            }
          },
          "question_text": {
            "type": "string",
            "minLength": 20
          },
          "i18n": {
            "$ref": "#/$defs/i18nLabel"
          },
          "scoring_modality": {
            "type": "string",
            "enum": ["TYPE_A", "TYPE_B", "TYPE_C", "TYPE_D", "TYPE_E", "TYPE_F"]
          },
          "required_evidence_keys": {
            "$ref": "#/$defs/evidenceKeyArray"
          },
          "evidence_expectations": {
            "type": "object",
            "minProperties": 1,
            "additionalProperties": {
              "type": ["boolean", "number"]
            }
          },
          "search_patterns": {
            "type": "object",
            "required": ["regex"],
            "additionalProperties": false,
            "properties": {
              "regex": {
                "type": "array",
                "items": {
                  "type": "string",
                  "minLength": 1
                },
                "uniqueItems": true
              }
            }
          },
          "scoring_criteria": {
            "type": "object",
            "minProperties": 1,
            "patternProperties": {
              "^[a-z_]+$": {
                "type": "object",
                "required": ["min_score", "criteria"],
                "additionalProperties": false,
                "properties": {
                  "min_score": {
                    "type": "number",
                    "minimum": 0,
                    "maximum": 1
                  },
                  "criteria": {
                    "type": "string",
                    "minLength": 5
                  }
                }
              }
            },
            "additionalProperties": false
          },
          "validation_checks": {
            "type": "object",
            "anyOf": [
              {"maxProperties": 0},
              {"minProperties": 1}
            ],
            "patternProperties": {
              "^.+$": {
                "type": "object",
                "properties": {
                  "patterns": {
                    "type": "array",
                    "items": {
                      "type": "string",
                      "minLength": 1
                    },
                    "uniqueItems": true
                  },
                  "minimum_required": {
                    "type": "integer",
                    "minimum": 0
                  },
                  "minimum_years": {
                    "type": "integer",
                    "minimum": 0
                  },
                  "specificity": {
                    "type": "string"
                  }
                },
                "additionalProperties": true
              }
            },
            "additionalProperties": false
          }
        }
      }
    }
  }
}
