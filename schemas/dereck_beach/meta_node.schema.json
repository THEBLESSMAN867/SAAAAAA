{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://policy.analysis/schemas/dereck_beach/meta_node.schema.json",
  "title": "CDAFMetaNode",
  "description": "Nodo meta del marco CDAF con trazabilidad causal, financiera y de riesgos contextualizados.",
  "type": "object",
  "required": ["id", "text", "type", "rigor_status", "dynamics", "test_type", "contextual_risks", "causal_justification", "audit_flags", "confidence_score"],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^[A-Z]{2}-\\d{3}$",
      "description": "Identificador canónico de la meta (ej. MP-001, MR-014)."
    },
    "text": {
      "type": "string",
      "minLength": 1,
      "maxLength": 2000,
      "description": "Extracto textual representativo de la meta o programa."
    },
    "type": {
      "type": "string",
      "enum": ["programa", "producto", "resultado", "impacto"],
      "description": "Clasificación jerárquica del nodo en la cadena causal."
    },
    "baseline": {
      "description": "Valor base reportado para el indicador (numérico, porcentaje o marcador ND).",
      "anyOf": [
        {
          "type": "number"
        },
        {
          "type": "string",
          "pattern": "^[0-9]+(?:[\\.,][0-9]+)?%?$"
        },
        {
          "type": "string",
          "enum": ["ND", "N/A", "POR DEFINIR", "SIN DATO"]
        },
        {
          "type": "null"
        }
      ]
    },
    "target": {
      "description": "Meta cuantitativa declarada para el indicador (valor o marcador ND).",
      "anyOf": [
        {
          "type": "number"
        },
        {
          "type": "string",
          "pattern": "^[0-9]+(?:[\\.,][0-9]+)?%?$"
        },
        {
          "type": "string",
          "enum": ["ND", "N/A", "POR DEFINIR", "SIN DATO"]
        },
        {
          "type": "null"
        }
      ]
    },
    "unit": {
      "type": ["string", "null"],
      "maxLength": 100,
      "description": "Unidad de medida asociada al indicador."
    },
    "responsible_entity": {
      "type": ["string", "null"],
      "maxLength": 200,
      "description": "Entidad responsable identificada en el texto."
    },
    "entity_activity": {
      "description": "Par entidad-actividad extraído mediante Process Tracing.",
      "oneOf": [
        {
          "$ref": "#/definitions/EntityActivity"
        },
        {
          "type": "null"
        }
      ]
    },
    "financial_allocation": {
      "type": ["number", "null"],
      "minimum": 0,
      "description": "Asignación presupuestal asociada a la meta en pesos constantes."
    },
    "unit_cost": {
      "type": ["number", "null"],
      "minimum": 0,
      "description": "Costo unitario estimado para entregar el producto o resultado."
    },
    "rigor_status": {
      "type": "string",
      "enum": ["fuerte", "débil", "sin_evaluar"],
      "description": "Calibración del rigor metodológico disponible para la meta."
    },
    "dynamics": {
      "type": "string",
      "enum": ["suma", "decreciente", "constante", "indefinido"],
      "description": "Dinámica esperada del indicador en la teoría de cambio."
    },
    "test_type": {
      "type": "string",
      "enum": ["hoop_test", "smoking_gun", "doubly_decisive", "straw_in_wind"],
      "description": "Tipo de prueba probatoria asignada según Beach & Pedersen."
    },
    "contextual_risks": {
      "type": "array",
      "description": "Factores de riesgo contextuales identificados para la meta.",
      "items": {
        "type": "string",
        "minLength": 3,
        "maxLength": 500
      }
    },
    "causal_justification": {
      "type": "array",
      "description": "Argumentos causales que respaldan la relación declarada.",
      "items": {
        "type": "string",
        "minLength": 5,
        "maxLength": 2000
      }
    },
    "audit_flags": {
      "type": "array",
      "description": "Alertas y banderas generadas durante las auditorías.",
      "items": {
        "type": "string",
        "minLength": 3,
        "maxLength": 200
      }
    },
    "confidence_score": {
      "type": "number",
      "minimum": 0.0,
      "maximum": 1.0,
      "description": "Puntaje de confianza agregada (0.0-1.0)."
    }
  },
  "additionalProperties": false,
  "definitions": {
    "EntityActivity": {
      "type": "object",
      "required": ["entity", "activity", "verb_lemma", "confidence"],
      "properties": {
        "entity": {
          "type": "string",
          "minLength": 2,
          "maxLength": 200,
          "description": "Actor o entidad que ejecuta la actividad causal."
        },
        "activity": {
          "type": "string",
          "minLength": 2,
          "maxLength": 200,
          "description": "Acción observada en el texto que moviliza el mecanismo."
        },
        "verb_lemma": {
          "type": "string",
          "minLength": 2,
          "maxLength": 100,
          "description": "Lema verbal asociado a la actividad principal."
        },
        "confidence": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Confianza asignada a la extracción del par entidad-actividad."
        }
      },
      "additionalProperties": false
    }
  }
}
